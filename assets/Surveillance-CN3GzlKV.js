var D=Object.defineProperty;var A=(s,t,n)=>t in s?D(s,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[t]=n;var _=(s,t,n)=>A(s,typeof t!="symbol"?t+"":t,n);import{w as H,b as w,j as e,D as U,E as V,c as T,O as h,Q as W,R as M,e as p,U as b,h as C,u as g,L as N,J as x,V as z,B as m,W as J,T as P,y as i,$ as K,X as G,A as X,C as d,Y}from"./index-DTDkP3dS.js";import{f as S,S as Z}from"./SearchFilter-BgZJ9vAz.js";import{d as k}from"./date-formatter-DO6EIGl4.js";import{P as ee}from"./pagination-BmPWLSst.js";import{u as se}from"./useQueryParam-CnjMrcY3.js";import{N as te}from"./Navbar-BhOrUXtn.js";/**
 * @license lucide-react v0.454.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=H("ArrowBigLeft",[["path",{d:"M18 15h-6v4l-7-7 7-7v4h6v6z",key:"lbrdak"}]]);class ne{constructor(){_(this,"url","/camera")}async update(t){const{plate:n,reason:r}=t;return(await w.put(`${this.url}/updatecar/${n}`,{reason:r})).data}async exitCar(t){return(await w.put(`${this.url}/getdata`,t)).data}}const re=new ne,ce=({data:s})=>{if(!s)return e.jsx(e.Fragment,{children:"no data"});const{cars:t,...n}=s;return e.jsxs("div",{className:"border rounded-2xl gap-2 flex overflow-hidden flex-col h-full  relative",children:[e.jsxs(U,{className:"w-full overflow-auto relative mb-10",children:[e.jsx(xe,{}),e.jsx(V,{children:t.map((r,c)=>e.jsx(ue,{item:r,index:(n.page-1)*n.limit+c+1},r.id))})]}),e.jsx(ee,{...n})]})},y=s=>{const t=Object.entries(s).sort();return T({queryKey:["car-stay",...t],queryFn:()=>h.getList(s),placeholderData:W})},le=(s,t)=>T({queryKey:[],queryFn:()=>h.getById(s),enabled:t,staleTime:0}),oe=()=>{const{addCar:s,deleteCar:t}=M();return p({mutationFn:n=>h.getCarByPut({EventComment:n}),onSuccess:n=>{t(),s(n.car)}})},E=()=>{const{params:s}=b(),{refetch:t}=y(s);return p({mutationFn:n=>re.update(n),onSuccess:()=>{t()}})},ie=()=>{const{mutate:s}=E();return p({mutationFn:t=>h.manualPayedMutation({amount:t.amount,parkno:t.parkno}),onSuccess:(t,{car_number:n,close:r})=>{s({plate:n}),r()}})},de=()=>{const{data:s}=C();return p({mutationFn:t=>h.printCar({...t,username:s==null?void 0:s.username})})},F=({id:s,status:t,carNumber:n})=>{const{t:r}=g(),{close:c}=N(),{params:f}=b(),{refetch:j}=y(f),{mutate:u}=oe(),{data:l}=le(String(s),t=="Exited"),[o,B]=x.useState(!1),[v,R]=x.useState(""),{mutate:$}=E(),{currentCar:a,addCar:L,deleteCar:Q}=M(),{mutate:I}=ie(),{mutate:O}=de();return x.useEffect(()=>{t!="Exited"?u(n,{onSuccess:()=>j()}):l&&(Q(),L(l))},[l==null?void 0:l.id]),e.jsxs("div",{className:"w-[800px] p-4 bg-white text-black rounded-2xl gap-2 flex flex-col relative border",children:[e.jsx("span",{onClick:()=>{c()},className:"absolute top-4 right-4",children:e.jsx(z,{size:22})}),o?e.jsxs("div",{className:"h-fit flex flex-col ",children:[e.jsx("span",{className:"absolute top-4 left-4",onClick:()=>B(!1),children:e.jsx(ae,{})}),e.jsx(J,{placeholder:"Reason",className:"mb-4 mt-10",onChange:q=>R(q.target.value),value:v}),e.jsx(m,{onClick:()=>a&&$({plate:a==null?void 0:a.car_number,reason:v},{onSuccess:()=>{c()}}),className:"bg-red-500 hover:bg-red-400",children:"Tolemedi"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-4 text-lg",children:[e.jsxs("p",{className:"font-semibold",children:[r("carnumber"),": "]}),e.jsx("p",{className:"font-semibold ",children:a==null?void 0:a.car_number})]}),e.jsxs("div",{className:"flex items-center gap-4 text-lg",children:[e.jsxs("p",{className:"font-semibold",children:[r("price"),": "]}),e.jsx("span",{className:"font-semibold  bg-green-600 py-0.5 px-1.5 text-white rounded-sm",children:(a==null?void 0:a.total_payment)===0?r("monthly-tariff"):`${a==null?void 0:a.total_payment} TMT`})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("p",{className:"",children:[r("entertime")," "]}),e.jsx("p",{className:" ",children:k(a==null?void 0:a.start_time)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("p",{className:"",children:[r("exittime")," "]}),e.jsx("p",{className:"",children:k(a==null?void 0:a.end_time)})]})]})]}),e.jsx("img",{src:a==null?void 0:a.image_url,className:"rounded-2xl",alt:""}),t!="Exited"&&e.jsxs(e.Fragment,{children:[e.jsx(m,{onClick:()=>{a&&a.total_payment!==void 0&&I({amount:a.total_payment,parkno:a.park_no,car_number:a.car_number,close:()=>c()})},className:"bg-white border-2 text-green-600 border-green-500 hover:text-white",disabled:!a||a.total_payment===void 0,children:r("payed")}),e.jsx(m,{onClick:()=>{a&&O({notification:{car_number:a==null?void 0:a.car_number,car_stay_id:a==null?void 0:a.id},price:a.total_payment,stayed_at:a.start_time})},className:"bg-white border-2 text-blue-600 border-blue-500 hover:text-white hover:bg-blue-400",children:r("print")})]})]})]})},ue=({item:s,index:t})=>{const{t:n}=g(),{changeModal:r}=N(),c=()=>{r(e.jsx(F,{id:s.id,status:s.status,carNumber:s.car_number}))};return e.jsxs(P,{className:"",children:[e.jsx(i,{className:"text-center",children:t}),e.jsx(i,{className:"flex justify-center text-center",children:e.jsx("div",{className:`${s.status==="Exited"?"bg-green-500":s.status==="Pending"?"bg-red-500":"bg-yellow-500"} w-10 h-10 text-white flex justify-center items-center rounded-md `,children:s.park_no})}),e.jsx(i,{className:"text-center",children:s.car_number}),e.jsx(i,{className:"text-center",children:S(s.start_time)}),e.jsx(i,{className:"text-center",children:S(s.end_time)}),e.jsx(i,{className:"text-center",children:s.status==="Exited"&&(s==null?void 0:s.total_payment)===0?n("monthly-tariff"):`${s==null?void 0:s.total_payment} TMT`}),e.jsxs(i,{className:"flex gap-2 justify-center",children:[e.jsx(m,{onClick:c,className:"bg-green-500 hover:bg-green-400",children:n("manual-pay")}),e.jsx(K,{bannerVisible:!1,maskOpacity:.5,children:e.jsx(G,{src:s.image_url,children:e.jsx(m,{className:"bg-blue-500 hover:bg-blue-400",children:n("photo")})})})]})]})},xe=()=>{const{t:s}=g();return e.jsx(X,{className:"bg-green-500 text-white sticky top-0",children:e.jsxs(P,{className:"text-white",children:[e.jsx(d,{className:"text-white text-center",children:"No"}),e.jsx(d,{className:"text-white text-center",children:s("parkno")}),e.jsx(d,{className:"text-white text-center",children:s("carnumber")}),e.jsx(d,{className:"text-white text-center",children:s("entertime")}),e.jsx(d,{className:"text-white text-center",children:s("exit-time")}),e.jsx(d,{className:"text-white text-center",children:s("price")}),e.jsx(d,{className:"text-white text-center",children:s("actions")})]})})},Ne=()=>{const{changeModal:s}=N(),{data:t}=C(),{getQuery:n}=se(),{setParams:r,params:c}=b();x.useEffect(()=>{r({page:Number(n("page")??"1"),limit:10,car_number:n("search"),enter_time:n("starttime"),end_time:n("endtime"),status:n("status")})},[n("page"),n("search"),n("starttime"),n("endtime"),n("status")]);const{refetch:f,data:j}=y(c);return x.useEffect(()=>{const u=new WebSocket(`${Y}/ws/notification`);return u.onopen=function(){console.log("Соединение установлено")},u.onmessage=function(l){const o=JSON.parse(l.data);(t==null?void 0:t.role)==="operator"&&o.park_no===t.parkno?s(e.jsx(F,{carNumber:o.car_number,status:o.status,id:o.id})):o=="refresh"&&f()},u.onclose=function(){console.log("Соединение закрыто")},()=>{u.close()}},[]),e.jsxs("div",{className:"w-full h-full p-6 flex flex-col gap-4 relative",children:[e.jsx(te,{title:"Video Surveillance"}),e.jsx(Z,{}),e.jsx(ce,{data:j})]})};export{Ne as default};
